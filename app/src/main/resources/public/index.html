<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <!-- import CSS -->
    <link rel="stylesheet" href="//unpkg.zhimg.com/element-ui/lib/theme-chalk/index.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>冒险岛gm后台管理页面</title>
    <style>
        h3 {
            color: black;
            text-align: center;
        }
        
        .login-card {
            width: 480px;
            margin: auto;
        }
        
        .flex {
            display: flex;
        }
    </style>
    <!-- import Vue before Element -->
    <script src="//unpkg.zhimg.com/vue@2/dist/vue.js"></script>
</head>

<body>
    <div id="app" style="display: none;">
        <h3>大白冒险岛gm控制台</h3>
        <el-card class="login-card" v-if="isShowLoginCard">
            <el-input v-model="username" type="text" placeholder="请输入账号" style="margin-bottom: 20px;"></el-input>
            <el-input v-model="password" type="password" placeholder="请输入密码" style="margin-bottom: 20px;"></el-input>
            <el-button type="primary" @click="login">登录</el-button>
        </el-card>
        <el-card v-else>
            <div class="flex">
                <el-button type="primary" @click="getMapleCharacterCount">查询总计在线人数</el-button>
                <el-input v-model="closeServerTime" type="number" placeholder="请输入关服时间（单位分钟）" style="margin: 0 16px;width: 220px"></el-input>
                <el-button type="primary" @click="closeServer">关闭服务器</el-button>
                <el-button type="primary" @click="sendAllServerNotice">发送全服公告</el-button>
                <el-button type="primary" @click="disconnectAllServerPlayer">断开全服玩家连接</el-button>
            </div>
            <el-tabs v-model="activeName" style="height: 500px;">
                <el-tab-pane label="玩家管理" name="playerManger">玩家管理</el-tab-pane>
                <el-tab-pane label="保存数据" name="saveData">保存数据</el-tab-pane>
                <el-tab-pane label="重载系列" name="configManger">重载系列</el-tab-pane>
                <el-tab-pane label="卡号处理" name="stuckAccountHandler">卡号处理</el-tab-pane>
                <el-tab-pane label="账号服务" name="accountService">账号服务</el-tab-pane>
            </el-tabs>
        </el-card>
    </div>

    <!-- import JavaScript -->
    <script src="//unpkg.zhimg.com/element-ui/lib/index.js"></script>
    <!-- import axios-->
    <script src="//unpkg.zhimg.com/axios/dist/axios.min.js"></script>
    <script src="./static/request.js"></script>
    <script>
        var app = new Vue({
            el: '#app',
            data: function() {
                return {
                    isShowLoginCard: true,
                    username: '',
                    password: '',
                    closeServerTime: null,
                    activeName: 'playerManger'
                }
            },
            methods: {
                async login() {
                    const data = await request({
                        method: 'get',
                        url: '/login',
                        params: {
                            username: this.username,
                            password: this.password
                        }
                    });
                    sessionStorage.setItem('token', data.data);
                    this.isShowLoginCard = false;
                },
                async check() {
                    return request({
                        method: 'get',
                        url: '/protected/check',
                    });
                },
                async getMapleCharacterCount() {
                    const data = await request({
                        method: 'get',
                        url: '/protected/getMapleCharacterCount',
                    });
                    const count = data.data.count;
                    this.$message.info("当前服务器在线人数总计:" + count + "个");
                },
                /** 关闭服务器 */
                async closeServer() {
                    if (!this.closeServerTime || this.closeServerTime < 0) {
                        this.$message.error("请先输入关服时间，单位分，大于0");
                        return
                    }
                    const data = await request({
                        method: 'get',
                        url: '/protected/closeServer',
                        params: {
                            time: this.closeServerTime
                        }
                    });
                    this.$message({
                        message: data.msg,
                        type: 'success'
                    });
                },
                /** 发送全服公告 */
                async sendAllServerNotice() {
                    this.$prompt('请输入公告内容', '提示', {
                        confirmButtonText: '发送',
                        cancelButtonText: '取消',
                        inputPattern: /(.*?)/,
                        inputErrorMessage: '不允许换行符'
                    }).then(async({
                        value
                    }) => {
                        const data = await request({
                            method: 'get',
                            url: '/protected/sendAllServerNotice',
                            params: {
                                content: value
                            }
                        });
                    }).catch((msg) => {

                    });
                },
                /** 断开全服玩家连接 */
                async disconnectAllServerPlayer() {
                    await request({
                        method: 'get',
                        url: '/protected/disconnectAllServerPlayer',
                    });
                    this.$message({
                        message: '断开全服玩家连接成功',
                        type: 'success'
                    });
                }
            },
            created() {
                this.check().then(() => {
                    // 通过token校验
                    this.isShowLoginCard = false;
                }).catch((msg) => {
                    // 没通过
                    console.log('msg', msg)
                    this.isShowLoginCard = true;
                })
                document.getElementById("app").setAttribute("style", "")
            }
        })
    </script>

</body>

</html>